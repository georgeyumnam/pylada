

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Example: Epitaxial relaxation method &mdash; LaDa 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="top" title="LaDa 1.0 documentation" href="../../index.html" />
    <link rel="up" title="Interface to VASP" href="../vasp.html" />
    <link rel="next" title="Organized high-throughput calculations: job-folders" href="../jobfolders.html" />
    <link rel="prev" title="A meta-functional: Strain relaxation" href="relax.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../jobfolders.html" title="Organized high-throughput calculations: job-folders"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="relax.html" title="A meta-functional: Strain relaxation"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">LaDa 1.0 documentation</a> &raquo;</li>
          <li><a href="../../userguide.html" >User Guide</a> &raquo;</li>
          <li><a href="../vasp.html" accesskey="U">Interface to VASP</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="example-epitaxial-relaxation-method">
<span id="vasp-example-ug"></span><h1>Example: Epitaxial relaxation method<a class="headerlink" href="#example-epitaxial-relaxation-method" title="Permalink to this headline">Â¶</a></h1>
<p>Absent dislocations, a film grown epitaxially on a substrate adopts the
in-plane lattice parameters of that substrate. It is possible to model a
sufficiently thick film as a bulk material on a virtual substrate. The trick is
simply to lock the in-plane parameters while allowing the out-plane direction
to relax.</p>
<p><a class="reference external" href="http://www.vasp.at/">VASP</a> does not allow for this kind of relaxation directly. However, using LaDa
when can simply design a method which will magically perform the relaxation.
Below, a method based on the <a class="reference external" href="http://en.wikipedia.org/wiki/Secant_method">secant</a> method is presented:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Find interval for which stress changes sign.</li>
<li>Bisect interval until required accuracy is obtained.</li>
</ol>
</div></blockquote>
<p>Admittedly, if one were smart, one could design a faster optimization method.
Or one could use the optimization methods provided by <a class="reference external" href="http://www.scipy.org/">scipy</a> with a
<tt class="xref py py-class docutils literal"><span class="pre">Vasp</span></tt> object, and be done with it, say this <a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.brent.html">one</a>.</p>
<p>First, we need a function capable of creating a strain matrix for the
particular kind we have in mind, and apply it to the structure. The strain
matrix can be obtained simply as the outer product of the epitaxial direction with itself.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">strain</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Creates new structure with given input strain in c direction. &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">inv</span>
  <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">outer</span><span class="p">,</span> <span class="n">dot</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="c"># define strain matrix</span>
  <span class="n">strain</span> <span class="o">=</span> <span class="n">outer</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> 
  <span class="c"># strain cell matrix and atoms</span>
  <span class="n">result</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">cell</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">strain</span><span class="p">,</span> <span class="n">structure</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">dot</span><span class="p">(</span><span class="n">strain</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
  <span class="c"># return result.</span>
  <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>The next step is to create a function which will compute the total energy of a
strained structure while relaxing internal degrees of freedom.
<a class="reference external" href="http://www.vasp.at/">VASP</a> is invoked in a separate sub-directory.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">vasp</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
  <span class="n">directory</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="s">&quot;relax_ions&quot;</span><span class="p">,</span> <span class="s">&quot;{0:0&lt;12.10}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
  <span class="k">return</span> <span class="n">vasp</span><span class="p">(</span><span class="n">strain</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">structure</span><span class="p">),</span> <span class="n">directory</span><span class="p">,</span> <span class="n">relaxation</span><span class="o">=</span><span class="s">&#39;ionic&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>The third component is a function to return the stress component in the
epitaxial direction.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">component</span><span class="p">(</span><span class="n">extract</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Returns relevant stress component. &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">dot</span>
  <span class="k">return</span> <span class="n">dot</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">extract</span><span class="o">.</span><span class="n">stress</span><span class="p">),</span> <span class="n">direction</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we have all the pieces to put the bisecting algorithm together:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">epitaxial</span><span class="p">(</span><span class="n">vasp</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">epiconv</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
              <span class="n">initstep</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="c"># Compute initial structure.</span>
  <span class="n">xstart</span> <span class="o">=</span> <span class="mf">0.0</span>
  <span class="n">estart</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">vasp</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">xstart</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  
  <span class="c"># then checks stress for direction in which to release strain.</span>
  <span class="n">stress_direction</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">component</span><span class="p">(</span><span class="n">estart</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0e0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.0</span>
  <span class="n">xend</span> <span class="o">=</span> <span class="n">initstep</span> <span class="k">if</span> <span class="n">stress_direction</span> <span class="o">&gt;</span> <span class="mf">0e0</span> <span class="k">else</span> <span class="o">-</span><span class="n">initstep</span>
  <span class="n">eend</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">vasp</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">xend</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="c"># make sure xend is on other side of stress tensor sign.</span>
  <span class="k">while</span> <span class="n">stress_direction</span> <span class="o">*</span> <span class="n">component</span><span class="p">(</span><span class="n">eend</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0e0</span><span class="p">:</span>
    <span class="n">xstart</span><span class="p">,</span> <span class="n">estart</span> <span class="o">=</span> <span class="n">xend</span><span class="p">,</span> <span class="n">eend</span>
    <span class="n">xend</span> <span class="o">+=</span> <span class="n">initstep</span> <span class="k">if</span> <span class="n">stress_direction</span> <span class="o">&gt;</span> <span class="mf">0e0</span> <span class="k">else</span> <span class="o">-</span><span class="n">initstep</span>
    <span class="n">eend</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">vasp</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">xend</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  
  <span class="c"># now we have a bracket. We start bisecting it.</span>
  <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">estart</span><span class="o">.</span><span class="n">total_energy</span> <span class="o">-</span> <span class="n">eend</span><span class="o">.</span><span class="n">total_energy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">epiconv</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="p">)):</span>
    <span class="c"># bisect interval and launch vasp.</span>
    <span class="n">xmid</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">xend</span> <span class="o">+</span> <span class="n">xstart</span><span class="p">)</span>
    <span class="n">emid</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">vasp</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">xmid</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c"># change interval depending on strain.</span>
    <span class="k">if</span> <span class="n">stress_direction</span> <span class="o">*</span> <span class="n">component</span><span class="p">(</span><span class="n">emid</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">xstart</span><span class="p">,</span> <span class="n">estart</span> <span class="o">=</span> <span class="n">xmid</span><span class="p">,</span> <span class="n">emid</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">xend</span><span class="p">,</span> <span class="n">eend</span> <span class="o">=</span> <span class="n">xmid</span><span class="p">,</span> <span class="n">emid</span>

  <span class="c"># Finally, perform one last static calculation.</span>
  <span class="n">efinal</span> <span class="o">=</span> <span class="n">eend</span> <span class="k">if</span> <span class="n">estart</span><span class="o">.</span><span class="n">total_energy</span> <span class="o">&gt;</span> <span class="n">eend</span><span class="o">.</span><span class="n">total_energy</span> <span class="k">else</span> <span class="n">estart</span>
  <span class="k">return</span> <span class="n">vasp</span><span class="p">(</span><span class="n">efinal</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="n">efinal</span><span class="p">,</span> <span class="n">relaxation</span><span class="o">=</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Lines 4 through 16 correspond to (1) above. Starting from the initial input
structure, we change the strain until an interval is found for which the stress
component changes direction. The structure with minimum total energy will
necessarily be found within this interval. Line 14 makes sure the interval is
kept as small as possible.</p>
<p>We then move to the second part (lines 19-25) of the algorithm: bisecting the
interval until the requisite convergence is achieved. Finally, one last static
calculation is performed before returning. That&#8217;s probably an overkill, but it
should be fairly cheap since we restart from the charge density and
wavefunctions of a previous calculations.</p>
<p>The full listing of the code is given below. There are some extra bits to it,
namely a docstring and some sanity checks on the function&#8217;s input parameter.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">strain</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Creates new structure with given input strain in c direction. &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">inv</span>
  <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">outer</span><span class="p">,</span> <span class="n">dot</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="c"># define strain matrix</span>
  <span class="n">strain</span> <span class="o">=</span> <span class="n">outer</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> 
  <span class="c"># strain cell matrix and atoms</span>
  <span class="n">result</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">cell</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">strain</span><span class="p">,</span> <span class="n">structure</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">dot</span><span class="p">(</span><span class="n">strain</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
  <span class="c"># return result.</span>
  <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">vasp</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
  <span class="n">directory</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="s">&quot;relax_ions&quot;</span><span class="p">,</span> <span class="s">&quot;{0:0&lt;12.10}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
  <span class="k">return</span> <span class="n">vasp</span><span class="p">(</span><span class="n">strain</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">structure</span><span class="p">),</span> <span class="n">directory</span><span class="p">,</span> <span class="n">relaxation</span><span class="o">=</span><span class="s">&#39;ionic&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">component</span><span class="p">(</span><span class="n">extract</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Returns relevant stress component. &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">dot</span>
  <span class="k">return</span> <span class="n">dot</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">extract</span><span class="o">.</span><span class="n">stress</span><span class="p">),</span> <span class="n">direction</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">epitaxial</span><span class="p">(</span><span class="n">vasp</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">epiconv</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
              <span class="n">initstep</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Performs epitaxial relaxation in given direction. </span>
<span class="sd">  </span>
<span class="sd">      Performs a relaxation for an epitaxial structure on a virtual substrate.</span>
<span class="sd">      The external (cell) coordinates of the structure can only relax in the</span>
<span class="sd">      growth/epitaxial direction. Internal coordinates (ions), however, are</span>
<span class="sd">      allowed to relax in whatever direction. </span>
<span class="sd">      </span>
<span class="sd">      Since VASP does not intrinsically allow for such a relaxation, it is</span>
<span class="sd">      performed by chaining different vasp calculations together. The</span>
<span class="sd">      minimization procedure itself is the secant method, enhanced by the</span>
<span class="sd">      knowledge of the stress tensor. The last calculation is static, for</span>
<span class="sd">      maximum accuracy.</span>

<span class="sd">      :param vasp: </span>
<span class="sd">        :py:class:`Vasp &lt;lada.vasp.Vasp&gt;` functional with wich to perform the</span>
<span class="sd">        relaxation.</span>
<span class="sd">      :param structure:</span>
<span class="sd">        :py:class:`Structure &lt;lada.crystal.Structure&gt;` for which to perform the</span>
<span class="sd">        relaxation.</span>
<span class="sd">      :param str outdir: </span>
<span class="sd">        Directory where to perform calculations. If None, defaults to current</span>
<span class="sd">        working directory. The intermediate calculations are stored in the</span>
<span class="sd">        relax_ions subdirectory.</span>
<span class="sd">      :param direction:</span>
<span class="sd">        Epitaxial direction. Defaults to [0, 0, 1].</span>
<span class="sd">      :param float epiconv: </span>
<span class="sd">        Convergence criteria of the total energy.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">getcwd</span>
  <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
  <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">norm</span>
  <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span>

  <span class="c"># takes care of input parameters.</span>
  <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">outdir</span> <span class="o">=</span> <span class="n">getcwd</span>
  <span class="n">vasp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">vasp</span><span class="p">)</span> <span class="c"># keep function stateless!</span>
  <span class="n">direction</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
  <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;relaxation&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="c"># we will be saying what to optimize.</span>
  <span class="k">if</span> <span class="s">&#39;ediff&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">vasp</span><span class="o">.</span><span class="n">ediff</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;ediff&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">vasp</span><span class="o">.</span><span class="n">ediff</span> <span class="o">&lt;</span> <span class="n">epiconv</span><span class="p">:</span> <span class="n">vasp</span><span class="o">.</span><span class="n">ediff</span> <span class="o">=</span> <span class="n">epiconv</span> <span class="o">*</span> <span class="mf">1e-2</span>

  <span class="c"># Compute initial structure.</span>
  <span class="n">xstart</span> <span class="o">=</span> <span class="mf">0.0</span>
  <span class="n">estart</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">vasp</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">xstart</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  
  <span class="c"># then checks stress for direction in which to release strain.</span>
  <span class="n">stress_direction</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">component</span><span class="p">(</span><span class="n">estart</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0e0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.0</span>
  <span class="n">xend</span> <span class="o">=</span> <span class="n">initstep</span> <span class="k">if</span> <span class="n">stress_direction</span> <span class="o">&gt;</span> <span class="mf">0e0</span> <span class="k">else</span> <span class="o">-</span><span class="n">initstep</span>
  <span class="n">eend</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">vasp</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">xend</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="c"># make sure xend is on other side of stress tensor sign.</span>
  <span class="k">while</span> <span class="n">stress_direction</span> <span class="o">*</span> <span class="n">component</span><span class="p">(</span><span class="n">eend</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0e0</span><span class="p">:</span>
    <span class="n">xstart</span><span class="p">,</span> <span class="n">estart</span> <span class="o">=</span> <span class="n">xend</span><span class="p">,</span> <span class="n">eend</span>
    <span class="n">xend</span> <span class="o">+=</span> <span class="n">initstep</span> <span class="k">if</span> <span class="n">stress_direction</span> <span class="o">&gt;</span> <span class="mf">0e0</span> <span class="k">else</span> <span class="o">-</span><span class="n">initstep</span>
    <span class="n">eend</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">vasp</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">xend</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  
  <span class="c"># now we have a bracket. We start bisecting it.</span>
  <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">estart</span><span class="o">.</span><span class="n">total_energy</span> <span class="o">-</span> <span class="n">eend</span><span class="o">.</span><span class="n">total_energy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">epiconv</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="p">)):</span>
    <span class="c"># bisect interval and launch vasp.</span>
    <span class="n">xmid</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">xend</span> <span class="o">+</span> <span class="n">xstart</span><span class="p">)</span>
    <span class="n">emid</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">vasp</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">xmid</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c"># change interval depending on strain.</span>
    <span class="k">if</span> <span class="n">stress_direction</span> <span class="o">*</span> <span class="n">component</span><span class="p">(</span><span class="n">emid</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">xstart</span><span class="p">,</span> <span class="n">estart</span> <span class="o">=</span> <span class="n">xmid</span><span class="p">,</span> <span class="n">emid</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">xend</span><span class="p">,</span> <span class="n">eend</span> <span class="o">=</span> <span class="n">xmid</span><span class="p">,</span> <span class="n">emid</span>

  <span class="c"># Finally, perform one last static calculation.</span>
  <span class="n">efinal</span> <span class="o">=</span> <span class="n">eend</span> <span class="k">if</span> <span class="n">estart</span><span class="o">.</span><span class="n">total_energy</span> <span class="o">&gt;</span> <span class="n">eend</span><span class="o">.</span><span class="n">total_energy</span> <span class="k">else</span> <span class="n">estart</span>
  <span class="k">return</span> <span class="n">vasp</span><span class="p">(</span><span class="n">efinal</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="n">efinal</span><span class="p">,</span> <span class="n">relaxation</span><span class="o">=</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="relax.html"
                        title="previous chapter">A <em>meta</em>-functional: Strain relaxation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../jobfolders.html"
                        title="next chapter">Organized high-throughput calculations: job-folders</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/userguide/vasp/example.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../jobfolders.html" title="Organized high-throughput calculations: job-folders"
             >next</a> |</li>
        <li class="right" >
          <a href="relax.html" title="A meta-functional: Strain relaxation"
             >previous</a> |</li>
        <li><a href="../../index.html">LaDa 1.0 documentation</a> &raquo;</li>
          <li><a href="../../userguide.html" >User Guide</a> &raquo;</li>
          <li><a href="../vasp.html" >Interface to VASP</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Mayeul d&#39;Avezac.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>